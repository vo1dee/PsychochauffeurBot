- name: Restart Bot Service
  env:
    CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
    CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
  run: |
    # Install cloudflared if not already installed
    wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
    sudo dpkg -i cloudflared-linux-amd64.deb
    
    # Test the service token
    echo "Testing Cloudflare Access authentication..."
    
    # SSH with proper environment variables
    ssh \
      -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      -o ProxyCommand="cloudflared access ssh --hostname %h" \
      deploy@psychochauffeur.internal.vo1dee.com \
      "sudo systemctl restart psychochauffeur-bot"
  shell: bash
